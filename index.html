<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ripasso Spagnolo ‚Äî Mobile (Completo)</title>
  <style>
    :root{
      --bg:#0f172a;
      --card:#111c33;
      --text:#e6eefc;
      --muted:#9fb0d2;
      --line:rgba(255,255,255,.12);

      --primary:#2563eb;
      --primary2:#1e40af;

      --ok:#16a34a;
      --okBg:rgba(22,163,74,.15);

      --bad:#dc2626;
      --badBg:rgba(220,38,38,.15);

      --shadow: 0 16px 40px rgba(0,0,0,.45);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(37,99,235,.18), transparent 60%),
        radial-gradient(700px 500px at 90% 30%, rgba(22,163,74,.14), transparent 60%),
        var(--bg);
      color:var(--text);
      display:flex;
      justify-content:center;
    }

    .container{
      width:100%;
      max-width:540px;
      padding:16px 14px 22px;
    }

    .top{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-bottom:12px;
    }

    .title{
      font-size:18px;
      font-weight:900;
      letter-spacing:.2px;
      margin:0;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    .statusRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top:6px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
      font-weight:800;
    }

    .progressWrap{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius:999px;
      overflow:hidden;
      height:10px;
      width:100%;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--primary), #22c55e);
      transition: width .25s ease;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      margin-top:12px;
    }

    .card h2{
      margin:0 0 8px;
      font-size:18px;
      font-weight:900;
    }
    .kicker{
      margin:0 0 12px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    .theoryBox{
      background: rgba(0,0,0,.22);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 13px;
      color:#dbe7ff;
      white-space: pre-wrap;
      margin:0;
      line-height:1.35;
    }

    .q{
      font-size:17px;
      font-weight:900;
      margin:0 0 10px;
    }

    .opt{
      width:100%;
      padding:14px 14px;
      margin-top:10px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      text-align:left;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
    }
    .opt:active{transform:scale(.99)}
    .opt[disabled]{opacity:.92; cursor:not-allowed;}
    .opt.correct{border-color: rgba(22,163,74,.75); background: var(--okBg);}
    .opt.wrong{border-color: rgba(220,38,38,.7); background: var(--badBg);}

    .feedback{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .feedback.ok{border-color: rgba(22,163,74,.7); background: var(--okBg); color: #d7ffe6;}
    .feedback.bad{border-color: rgba(220,38,38,.7); background: var(--badBg); color: #ffd7dc;}
    .feedback strong{color:var(--text)}

    .nav{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:14px;
    }

    button.navBtn{
      width:100%;
      padding:14px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      font-size:15px;
      font-weight:900;
      cursor:pointer;
    }
    button.navBtn.primary{
      background: var(--primary);
      border-color: rgba(255,255,255,.14);
    }
    button.navBtn.primary:active{background: var(--primary2);}
    button.navBtn[disabled]{opacity:.5; cursor:not-allowed;}

    .bottomNote{
      margin-top:12px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    .scoreBox{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .scoreItem{
      flex:1 1 auto;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px 12px;
      color:var(--muted);
      font-size:12px;
      font-weight:900;
      min-width: 160px;
    }
    .scoreItem span{color:var(--text)}
    .small{color:var(--muted); font-size:12px; margin-top:8px; line-height:1.35;}
    .hidden{display:none;}

    /* Home list */
    .list{
      display:grid;
      gap:10px;
      margin-top:12px;
    }
    .lessonBtn{
      width:100%;
      padding:14px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      text-align:left;
      cursor:pointer;
    }
    .lessonBtn:active{transform:scale(.99)}
    .lessonTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .lessonName{font-weight:950; font-size:15px; line-height:1.2;}
    .tag{
      font-size:11px;
      font-weight:900;
      color:var(--muted);
      border:1px solid var(--line);
      padding:5px 8px;
      border-radius:999px;
      white-space:nowrap;
      background: rgba(255,255,255,.03);
    }
    .lessonMeta{
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
      line-height:1.25;
    }
    .rowBtns{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .danger{
      background: rgba(220,38,38,.18) !important;
      border-color: rgba(220,38,38,.25) !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top">
      <p class="title">Ripasso Spagnolo ‚Äî Mobile</p>
      <p class="subtitle">
        Semplice e completo: <strong>Home</strong> ‚Üí scegli lezione ‚Üí micro-teoria ‚Üí 5 quiz con feedback immediato ‚Üí fine lezione ‚Üí (se serve) ‚ÄúRifai sbagliate‚Äù.
        Il progresso si salva sul dispositivo.
      </p>

      <div class="statusRow">
        <div class="pill" id="modePill">Home</div>
        <div class="pill" id="stepPill">Progresso</div>
      </div>

      <div class="progressWrap" aria-label="progresso">
        <div class="bar" id="bar"></div>
      </div>
    </div>

    <div class="card" id="card"></div>

    <div class="nav" id="nav">
      <button class="navBtn" id="backBtn">‚¨ÖÔ∏è Indietro</button>
      <button class="navBtn primary" id="nextBtn">Avanti ‚û°Ô∏è</button>
    </div>

    <div class="bottomNote" id="note"></div>
  </div>

<script>
  // ==========================================================
  // CONTENUTI: lezioni + 5 domande ciascuna (con spiegazione)
  // ==========================================================
  // Nota "senza allucinazioni": qui c'√® una struttura completa di ripasso sui tempi/strutture.
  // Se vuoi frasi/esempi IDENTICI del libro, vanno copiati 1:1 dal testo e inseriti.
  const lessons = [
    {
      id:"presente_regolari",
      title:"Presente indicativo ‚Äî verbi regolari",
      kicker:"Memorizza le desinenze -AR / -ER / -IR.",
      theory:`-AR (hablar): hablo, hablas, habla, hablamos, habl√°is, hablan
-ER (comer):  como, comes, come, comemos, com√©is, comen
-IR (vivir):  vivo, vives, vive, vivimos, viv√≠s, viven`,
      quiz:[
        { q:"Nosotros ____ (hablar) espa√±ol.", opts:["hablamos","hablan","habl√°is","hablo"], c:0, ex:"Con 'nosotros' -AR finisce in -amos: hablamos." },
        { q:"Vosotros ____ (comer) en casa.", opts:["comemos","com√©is","come","comen"], c:1, ex:"Con 'vosotros' -ER finisce in -√©is: com√©is." },
        { q:"Yo ____ (vivir) en Italia.", opts:["vive","vivo","vivimos","viven"], c:1, ex:"Con 'yo' -IR finisce in -o: vivo." },
        { q:"Ellas ____ (hablar) mucho.", opts:["hablamos","habl√°is","hablan","habla"], c:2, ex:"Con 'ellas/ellos' -AR finisce in -an: hablan." },
        { q:"T√∫ ____ (comer) pasta.", opts:["comes","como","comen","com√©is"], c:0, ex:"Con 't√∫' -ER finisce in -es: comes." }
      ]
    },
    {
      id:"ser_estar",
      title:"SER vs ESTAR",
      kicker:"SER = identit√†/definizione; ESTAR = stato/luogo.",
      theory:`SER: soy, eres, es, somos, sois, son
ESTAR: estoy, est√°s, est√°, estamos, est√°is, est√°n`,
      quiz:[
        { q:"'Sono italiano' ‚Üí", opts:["Estoy italiano","Soy italiano","Es italiano","Est√°s italiano"], c:1, ex:"Nazionalit√†/identit√† ‚Üí SER: soy italiano." },
        { q:"'Sono stanco' ‚Üí", opts:["Soy cansado","Estoy cansado","Es cansado","Est√°s cansado (io)"], c:1, ex:"Stato/condizione ‚Üí ESTAR: estoy cansado." },
        { q:"'√à a casa' ‚Üí", opts:["Es en casa","Est√° en casa","Soy en casa","Est√°n a casa"], c:1, ex:"Luogo ‚Üí ESTAR: est√° en casa." },
        { q:"'Siamo studenti' ‚Üí", opts:["Somos estudiantes","Estamos estudiantes","Son estudiantes","Sois estudiante"], c:0, ex:"Definizione/ruolo ‚Üí SER: somos estudiantes." },
        { q:"'La porta √® aperta' (risultato) ‚Üí", opts:["Es abierta","Est√° abierta","Soy abierta","Est√°s abierta"], c:1, ex:"Condizione/risultato ‚Üí ESTAR: est√° abierta." }
      ]
    },
    {
      id:"cambio_vocalico",
      title:"Cambio vocalico",
      kicker:"E‚ÜíIE, O‚ÜíUE, E‚ÜíI. Non cambia in nosotros/vosotros.",
      theory:`E‚ÜíIE: querer ‚Üí quiero, quieres, quiere / queremos, quer√©is / quieren
O‚ÜíUE: poder  ‚Üí puedo, puedes, puede / podemos, pod√©is / pueden
E‚ÜíI : pedir  ‚Üí pido, pides, pide / pedimos, ped√≠s / piden`,
      quiz:[
        { q:"Yo ____ (querer) dormir.", opts:["quero","quiero","queremos","quiere"], c:1, ex:"Querer fa E‚ÜíIE in 'yo': quiero." },
        { q:"Nosotros ____ (poder) entrar.", opts:["podemos","puedo","pueden","poder"], c:0, ex:"In 'nosotros' non cambia: podemos." },
        { q:"T√∫ ____ (pedir) ayuda.", opts:["pides","pidimos","pido","piden"], c:0, ex:"Pedir fa E‚ÜíI: t√∫ pides." },
        { q:"Vosotros ____ (querer) estudiar.", opts:["quer√©is","quieres","quiero","quieren"], c:0, ex:"Vosotros: quer√©is." },
        { q:"Ellos ____ (poder) venir.", opts:["podemos","pueden","puedo","poden"], c:1, ex:"Ellos: pueden (O‚ÜíUE)." }
      ]
    },
    {
      id:"yo_irregolari",
      title:"Irregolari in YO",
      kicker:"Irregolarit√† tipiche: tengo, vengo, digo, hago, pongo, salgo.",
      theory:`tener‚Üítengo | venir‚Üívengo | decir‚Üídigo | hacer‚Üíhago | poner‚Üípongo | salir‚Üísalgo`,
      quiz:[
        { q:"Yo ____ (tener) trece a√±os.", opts:["tengo","tienes","teno","tiene"], c:0, ex:"Tener in 'yo' ‚Üí tengo." },
        { q:"Yo ____ (decir) la verdad.", opts:["digo","dice","decimos","dices"], c:0, ex:"Decir in 'yo' ‚Üí digo." },
        { q:"Yo ____ (hacer) deporte.", opts:["hago","hace","hacen","hacemos"], c:0, ex:"Hacer in 'yo' ‚Üí hago." },
        { q:"Yo ____ (salir) ahora.", opts:["salgo","sales","sale","salen"], c:0, ex:"Salir in 'yo' ‚Üí salgo." },
        { q:"Yo ____ (poner) la mesa.", opts:["pongo","pones","pone","ponen"], c:0, ex:"Poner in 'yo' ‚Üí pongo." }
      ]
    },
    {
      id:"gustar",
      title:"Verbi tipo GUSTAR",
      kicker:"Me gusta (sing.) / me gustan (plur.).",
      theory:`Me gusta el f√∫tbol. (sing.)
Me gustan los libros. (plur.)
Simili: encantar, interesar, importar, doler, apetecer, quedar, sentar`,
      quiz:[
        { q:"A m√≠ ____ los libros.", opts:["me gusta","me gustan","te gustan","le gusta"], c:1, ex:"'Los libros' plurale ‚Üí me gustan." },
        { q:"A nosotros ____ la pizza.", opts:["nos gustan","nos gusta","me gusta","les gusta"], c:1, ex:"'La pizza' singolare ‚Üí nos gusta." },
        { q:"A ella ____ el f√∫tbol.", opts:["le gusta","le gustan","me gusta","se gusta"], c:0, ex:"A ella ‚Üí le. Singolare: le gusta." },
        { q:"A m√≠ ____ la cabeza. (doler)", opts:["me duelen","me duele","te duele","le duelen"], c:1, ex:"'La cabeza' singolare ‚Üí me duele." },
        { q:"A ellos ____ las piernas. (doler)", opts:["les duele","les duelen","le duelen","les dolor"], c:1, ex:"'Las piernas' plurale ‚Üí les duelen." }
      ]
    },
    {
      id:"riflessivi",
      title:"Verbi riflessivi",
      kicker:"Pronome + verbo: me/te/se/nos/os/se.",
      theory:`Ejemplo: levantarse
me levanto, te levantas, se levanta, nos levantamos, os levant√°is, se levantan`,
      quiz:[
        { q:"Yo ____ a las siete. (levantarse)", opts:["me levanto","levanto me","te levanto","se levanto"], c:0, ex:"Pronome prima: me levanto." },
        { q:"T√∫ ____ pronto. (ducharse)", opts:["te duchas","me duchas","se duchas","duchas te"], c:0, ex:"T√∫ ‚Üí te duchas." },
        { q:"√âl ____ a las diez. (acostarse)", opts:["me acuesto","se acuesta","te acuestas","nos acostamos"], c:1, ex:"√âl ‚Üí se acuesta." },
        { q:"Nosotros ____ en casa. (quedarse)", opts:["nos quedamos","se quedamos","me quedo","os qued√°is"], c:0, ex:"Nosotros ‚Üí nos quedamos." },
        { q:"Vosotros ____ tarde. (levantarse)", opts:["os levant√°is","nos levantamos","se levantan","levant√°is"], c:0, ex:"Vosotros ‚Üí os levant√°is." }
      ]
    },
    {
      id:"estar_gerundio",
      title:"Estar + gerundio",
      kicker:"Azione in corso: estoy/est√°s/est√° + gerundio.",
      theory:`hablar‚Üíhablando | comer‚Üícomiendo | vivir‚Üíviviendo
Estoy estudiando. / Est√° lloviendo.`,
      quiz:[
        { q:"'Sto studiando adesso' ‚Üí", opts:["Estudio ahora","Estoy estudiando","Soy estudiando","Estoy estudiar"], c:1, ex:"Azione in corso ‚Üí estar + gerundio: estoy estudiando." },
        { q:"√âl ____ (leer) ahora.", opts:["est√° leyendo","lee","est√° leer","es leyendo"], c:0, ex:"Estar + gerundio: est√° leyendo." },
        { q:"Nosotros ____ (comer) ahora.", opts:["estamos comiendo","comemos","somos comiendo","estamos comer"], c:0, ex:"Nosotros: estamos comiendo." },
        { q:"Ellas ____ (vivir) aqu√≠ ahora (progressivo).", opts:["est√°n viviendo","viven","est√°n vive","son viviendo"], c:0, ex:"Ellas: est√°n viviendo." },
        { q:"¬øT√∫ ____ (hablar) por tel√©fono ahora?", opts:["est√°s hablando","hablas","est√°s habla","eres hablando"], c:0, ex:"T√∫: est√°s hablando." }
      ]
    },
    {
      id:"indefinido_reg",
      title:"Pret√©rito indefinido ‚Äî regolari",
      kicker:"Passato concluso: ayer, el a√±o pasado, el lunes‚Ä¶",
      theory:`-AR: habl√©, hablaste, habl√≥, hablamos, hablasteis, hablaron
-ER/-IR: com√≠, comiste, comi√≥, comimos, comisteis, comieron`,
      quiz:[
        { q:"Ayer yo ____ pizza. (comer)", opts:["como","com√≠","com√≠a","he comido"], c:1, ex:"Ayer ‚Üí passato concluso ‚Üí indefinido: com√≠." },
        { q:"El domingo nosotros ____ por tel√©fono. (hablar)", opts:["hablamos","habl√°bamos","habl√©","hablar√©"], c:0, ex:"Indefinido -AR 'nosotros' = hablamos (uguale al presente: decide il contesto)." },
        { q:"T√∫ ____ una carta. (escribir)", opts:["escribiste","escribes","escrib√≠as","has escrito"], c:0, ex:"Indefinido (t√∫): escribiste." },
        { q:"Ellos ____ en casa. (vivir)", opts:["vivieron","viven","viv√≠an","han vivido"], c:0, ex:"Indefinido (ellos): vivieron." },
        { q:"Vosotros ____ r√°pido. (comer)", opts:["comisteis","com√©is","com√≠amos","comer√©is"], c:0, ex:"Indefinido (vosotros): comisteis." }
      ]
    },
    {
      id:"indefinido_irreg",
      title:"Pret√©rito indefinido ‚Äî irregolari chiave",
      kicker:"Da memorizzare: ser/ir, tener, estar, haber, decir (e altri).",
      theory:`ser/ir: fui, fuiste, fue, fuimos, fuisteis, fueron
tener: tuve‚Ä¶ | estar: estuve‚Ä¶ | haber: hubo | decir: dije`,
      quiz:[
        { q:"El a√±o pasado nosotros ____ a Madrid. (ir)", opts:["√≠bamos","fuimos","vamos","hemos ido"], c:1, ex:"Ser/ir all‚Äôindefinido: fuimos." },
        { q:"Ayer yo ____ un problema. (tener)", opts:["ten√≠a","tuve","tengo","he tenido"], c:1, ex:"Indefinido di tener: tuve." },
        { q:"Anoche √©l ____ en casa. (estar)", opts:["estaba","estuvo","est√°","ha estado"], c:1, ex:"Indefinido di estar: estuvo." },
        { q:"Ayer ____ mucha gente. (haber)", opts:["hab√≠a","hubo","hay","ha habido"], c:1, ex:"Indefinido di haber: hubo." },
        { q:"Yo ____ la verdad. (decir)", opts:["dec√≠a","dije","digo","he dicho"], c:1, ex:"Indefinido di decir: dije." }
      ]
    },
    {
      id:"perfecto",
      title:"Pret√©rito perfecto",
      kicker:"Oggi/questa settimana/ultimamente: he/has/ha‚Ä¶ + participio.",
      theory:`haber (presente): he, has, ha, hemos, hab√©is, han
participio: -ado / -ido
He estudiado. / Hemos comido.`,
      quiz:[
        { q:"Hoy ____ mucho. (estudiar)", opts:["estudi√©","he estudiado","estudiaba","hab√≠a estudiado"], c:1, ex:"Hoy ‚Üí collegato al presente ‚Üí he estudiado." },
        { q:"Esta semana nosotros ____ pizza. (comer)", opts:["comimos","hemos comido","com√≠amos","hab√≠amos comido"], c:1, ex:"Esta semana ‚Üí hemos comido." },
        { q:"¬øT√∫ ____ el libro? (leer)", opts:["le√≠ste","has le√≠do","le√≠as","hab√≠as le√≠do"], c:1, ex:"Perfecto: has le√≠do." },
        { q:"Ellos ____ tarde. (llegar)", opts:["llegaron","han llegado","llegaban","hab√≠an llegado"], c:1, ex:"Perfecto: han llegado." },
        { q:"Participio di 'hablar' √®:", opts:["hablido","hablado","hablaba","habl√©"], c:1, ex:"-AR ‚Üí -ado: hablado." }
      ]
    },
    {
      id:"imperfecto",
      title:"Imperfecto",
      kicker:"Descrizioni e abitudini nel passato: 'da piccolo‚Ä¶'.",
      theory:`-AR: hablaba‚Ä¶
-ER/-IR: com√≠a‚Ä¶
Irregolari: ser‚Üíera | ir‚Üíiba | ver‚Üíve√≠a`,
      quiz:[
        { q:"Cuando era peque√±o, yo ____ al f√∫tbol. (jugar)", opts:["jugu√©","jugaba","he jugado","hab√≠a jugado"], c:1, ex:"Abitudine nel passato ‚Üí jugaba." },
        { q:"Antes nosotros ____ en Roma. (vivir)", opts:["vivimos","viv√≠amos","vivimos (ayer)","hemos vivido"], c:1, ex:"Descrizione/abitudine ‚Üí viv√≠amos." },
        { q:"De ni√±o, ____ muy feliz. (ser, yo)", opts:["fui","era","soy","he sido"], c:1, ex:"Imperfecto di ser: era." },
        { q:"Cuando ten√≠a 10 a√±os, ____ a la escuela. (ir, yo)", opts:["fui","iba","voy","he ido"], c:1, ex:"Imperfecto di ir: iba." },
        { q:"Antes ____ la tele todas las noches. (ver, yo)", opts:["vi","ve√≠a","veo","he visto"], c:1, ex:"Imperfecto di ver: ve√≠a." }
      ]
    },
    {
      id:"imperfecto_gerundio",
      title:"Estaba + gerundio (passato in corso)",
      kicker:"Azione in corso nel passato: estaba + gerundio.",
      theory:`A las seis, estaba estudiando. (azione in corso in quel momento)`,
      quiz:[
        { q:"A las seis yo ____ cuando son√≥ el tel√©fono. (estudiar)", opts:["estudi√©","estaba estudiando","he estudiado","estudio"], c:1, ex:"Azione in corso in quel momento ‚Üí estaba estudiando." },
        { q:"Ellos ____ cuando llegu√©. (comer)", opts:["comieron","estaban comiendo","han comido","com√≠an (abitudine)"], c:1, ex:"Momento preciso ‚Üí estaban comiendo." },
        { q:"¬øT√∫ ____ por tel√©fono cuando te llam√©? (hablar)", opts:["hablaste","estabas hablando","has hablado","hablabas (generico)"], c:1, ex:"Momento preciso ‚Üí estabas hablando." },
        { q:"Nosotros ____ cuando empez√≥ a llover. (caminar)", opts:["caminamos","est√°bamos caminando","hemos caminado","camin√°bamos (abitudine)"], c:1, ex:"Azione in corso ‚Üí est√°bamos caminando." },
        { q:"Gerundio di 'vivir' √®:", opts:["vivando","viviendo","vivido","viv√≠a"], c:1, ex:"-IR ‚Üí -iendo: viviendo." }
      ]
    },
    {
      id:"pluscuamperfecto",
      title:"Pluscuamperfecto",
      kicker:"Azione precedente nel passato: hab√≠a + participio.",
      theory:`haber (imperfecto): hab√≠a, hab√≠as, hab√≠a, hab√≠amos, hab√≠ais, hab√≠an
Cuando llegu√©, ya hab√≠a empezado.`,
      quiz:[
        { q:"Cuando llegu√©, la clase ya ____. (empezar)", opts:["empez√≥","hab√≠a empezado","ha empezado","empezaba"], c:1, ex:"Azione prima di un‚Äôaltra nel passato ‚Üí hab√≠a empezado." },
        { q:"Yo ____ antes de salir. (comer)", opts:["com√≠","hab√≠a comido","he comido","com√≠a"], c:1, ex:"Prima di un‚Äôaltra azione nel passato ‚Üí hab√≠a comido." },
        { q:"Ellos ____ el libro cuando lo ped√≠. (leer)", opts:["leyeron","hab√≠an le√≠do","han le√≠do","le√≠an"], c:1, ex:"Pluscuamperfecto: hab√≠an le√≠do." },
        { q:"Nosotros ____ la tarea antes de cenar. (hacer)", opts:["hicimos","hab√≠amos hecho","hemos hecho","hac√≠amos"], c:1, ex:"Pluscuamperfecto: hab√≠amos hecho." },
        { q:"Forma corretta: yo + pluscuamperfecto di estudiar", opts:["hab√≠a estudiado","he estudiado","estuve estudiado","estudiaba"], c:0, ex:"Pluscuamperfecto = hab√≠a + participio." }
      ]
    },
    {
      id:"futuro_simple",
      title:"Futuro simple ‚Äî regolare",
      kicker:"Infinito + -√©, -√°s, -√°, -emos, -√©is, -√°n.",
      theory:`hablar√©, hablar√°s, hablar√°, hablaremos, hablar√©is, hablar√°n`,
      quiz:[
        { q:"Ma√±ana yo ____ a mi amigo. (llamar)", opts:["llamo","llamar√©","he llamado","llamaba"], c:1, ex:"Futuro (yo): llamar√©." },
        { q:"T√∫ ____ ma√±ana. (hablar)", opts:["hablas","hablar√°s","hablaste","has hablado"], c:1, ex:"Futuro (t√∫): hablar√°s." },
        { q:"Nosotros ____ pronto. (salir, regolare)", opts:["salimos","saldremos","saliremos","hemos salido"], c:2, ex:"Futuro regolare: saliremos." },
        { q:"Ellos ____ en verano. (viajar)", opts:["viajan","viajar√°n","viajaron","viajaban"], c:1, ex:"Futuro (ellos): viajar√°n." },
        { q:"Vosotros ____ m√°s tarde. (comer)", opts:["com√©is","comer√©is","comisteis","com√≠an"], c:1, ex:"Futuro (vosotros): comer√©is." }
      ]
    },
    {
      id:"futuro_irreg",
      title:"Futuro ‚Äî irregolari pi√π comuni",
      kicker:"Cambia la radice, ma le desinenze restano uguali.",
      theory:`tener‚Üítendr√© | venir‚Üívendr√© | poder‚Üípodr√© | decir‚Üídir√© | hacer‚Üíhar√© | haber‚Üíhabr√°`,
      quiz:[
        { q:"Yo ____ ma√±ana. (tener)", opts:["tener√©","tendr√©","tuve","ten√≠a"], c:1, ex:"Futuro irregolare: tendr√©." },
        { q:"√âl ____ m√°s tarde. (venir)", opts:["venir√°","vendr√°","vino","ven√≠a"], c:1, ex:"Futuro irregolare: vendr√°." },
        { q:"Nosotros ____ hacerlo. (poder)", opts:["podremos","podemos","pudimos","podr√≠amos"], c:0, ex:"Futuro irregolare: podremos." },
        { q:"Yo ____ la verdad. (decir)", opts:["dir√©","decir√©","dije","digo"], c:0, ex:"Futuro irregolare: dir√©." },
        { q:"Ma√±ana ____ sol. (haber)", opts:["hay","hab√≠a","habr√°","hubo"], c:2, ex:"Futuro di haber: habr√°." }
      ]
    },
    {
      id:"ir_a_inf",
      title:"Ir a + infinitivo",
      kicker:"Futuro vicino / intenzione: voy a‚Ä¶",
      theory:`voy a estudiar | vas a salir | va a llover | vamos a comer`,
      quiz:[
        { q:"'Stiamo per uscire' ‚Üí", opts:["Vamos salir","Vamos a salir","Fuimos a salir","Hemos salir"], c:1, ex:"Ir a + infinitivo ‚Üí vamos a salir." },
        { q:"Yo ____ estudiar ahora. (ir a)", opts:["voy a","vaya","va a","fui a"], c:0, ex:"Yo: voy a estudiar." },
        { q:"¬øT√∫ ____ venir ma√±ana? (ir a)", opts:["vas a","vais a","van a","ibas a"], c:0, ex:"T√∫: vas a venir." },
        { q:"√âl ____ llover. (sta per piovere)", opts:["va a","voy a","van a","iba a"], c:0, ex:"√âl: va a llover." },
        { q:"Nosotros ____ comer. (ir a)", opts:["vamos a","vamos","fuimos a","hemos a"], c:0, ex:"Nosotros: vamos a comer." }
      ]
    }
  ];

  // ==========================================================
  // PERSISTENZA (localStorage)
  // ==========================================================
  const STORAGE_KEY = "spn_ripasso_v1";

  function defaultSave(){
    return {
      // per lesson: best score and last run info
      perLesson: lessons.map(() => ({
        bestCorrect: 0,
        bestAnswered: 5,
        lastCorrect: 0,
        lastAnswered: 0,
        completed: false,
        wrongLast: [] // indices of wrong questions from last run (0..4)
      })),
      totals: { bestCorrect: 0, bestAnswered: lessons.length * 5 },
      // last position to continue
      lastPosition: { mode:"home", lessonIndex:0, step:"theory", questionIndex:0, retryWrong:false, wrongQueue:[] }
    };
  }

  function loadSave(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaultSave();
      const parsed = JSON.parse(raw);
      // basic shape guard
      if(!parsed || !parsed.perLesson || !Array.isArray(parsed.perLesson)) return defaultSave();
      // if lesson count changed, rebuild but try to keep existing
      if(parsed.perLesson.length !== lessons.length){
        const fresh = defaultSave();
        for(let i=0;i<Math.min(parsed.perLesson.length, fresh.perLesson.length);i++){
          fresh.perLesson[i] = { ...fresh.perLesson[i], ...parsed.perLesson[i] };
        }
        fresh.totals = parsed.totals || fresh.totals;
        fresh.lastPosition = parsed.lastPosition || fresh.lastPosition;
        return fresh;
      }
      return parsed;
    }catch{
      return defaultSave();
    }
  }

  function saveNow(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(save));
  }

  function resetProgress(){
    save = defaultSave();
    saveNow();
  }

  // ==========================================================
  // STATE (runtime)
  // modes: home | theory | quiz | lesson_end | final
  // ==========================================================
  let save = loadSave();

  const state = {
    mode: save.lastPosition?.mode || "home",
    lessonIndex: clampInt(save.lastPosition?.lessonIndex, 0, lessons.length-1, 0),
    questionIndex: clampInt(save.lastPosition?.questionIndex, 0, 4, 0),

    // current run stats
    answered: false,
    runCorrect: 0,
    runAnswered: 0,
    wrongThisRun: [],

    // retry wrong mode
    retryWrong: !!save.lastPosition?.retryWrong,
    wrongQueue: Array.isArray(save.lastPosition?.wrongQueue) ? save.lastPosition.wrongQueue.slice() : [],

    // for quiz rendering
    currentQuizIndices: [] // either [0..4] or wrongQueue
  };

  const el = (id) => document.getElementById(id);

  function clampInt(v, min, max, fallback){
    const n = Number(v);
    if(!Number.isFinite(n)) return fallback;
    return Math.max(min, Math.min(max, Math.trunc(n)));
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function lessonScoreText(i){
    const s = save.perLesson[i];
    const bestPct = s.bestAnswered ? Math.round((s.bestCorrect/s.bestAnswered)*100) : 0;
    const lastPct = s.lastAnswered ? Math.round((s.lastCorrect/s.lastAnswered)*100) : 0;
    return { bestPct, lastPct };
  }

  function overallProgressPct(){
    // percent lessons completed
    const done = save.perLesson.filter(x => x.completed).length;
    return Math.round((done / lessons.length) * 100);
  }

  function setTopUI(){
    const pct = overallProgressPct();
    el("bar").style.width = pct + "%";
    el("stepPill").textContent = `Completate: ${save.perLesson.filter(x=>x.completed).length}/${lessons.length}`;
    el("modePill").textContent =
      state.mode === "home" ? "Home" :
      state.mode === "theory" ? "Teoria" :
      state.mode === "quiz" ? (state.retryWrong ? "Quiz: Rifai sbagliate" : "Quiz") :
      state.mode === "lesson_end" ? "Fine lezione" :
      "Finale";
  }

  function setNav(visible){
    el("nav").style.display = visible ? "" : "none";
  }

  function updateLastPosition(){
    save.lastPosition = {
      mode: state.mode,
      lessonIndex: state.lessonIndex,
      step: state.mode,
      questionIndex: state.questionIndex,
      retryWrong: state.retryWrong,
      wrongQueue: state.wrongQueue.slice()
    };
    saveNow();
  }

  // ==========================================================
  // HOME
  // ==========================================================
  function renderHome(){
    setNav(false);
    const items = lessons.map((L, i) => {
      const s = save.perLesson[i];
      const { bestPct, lastPct } = lessonScoreText(i);
      const status = s.completed ? "Completata" : "Da fare";
      const tag = s.completed ? "‚úÖ " + status : "üïí " + status;
      const wrongCount = (s.wrongLast || []).length;
      const extra = wrongCount > 0
        ? `Ultima volta: ${s.lastCorrect}/${s.lastAnswered} (${lastPct}%). Sbagliate: ${wrongCount}.`
        : `Ultima volta: ${s.lastAnswered ? `${s.lastCorrect}/${s.lastAnswered} (${lastPct}%)` : "‚Äî"}.`;

      const bestLine = `Migliore: ${s.bestCorrect}/${s.bestAnswered} (${bestPct}%).`;

      return `
        <button class="lessonBtn" onclick="startLesson(${i})">
          <div class="lessonTop">
            <div class="lessonName">${escapeHtml(L.title)}</div>
            <div class="tag">${tag}</div>
          </div>
          <div class="lessonMeta">${escapeHtml(L.kicker)}</div>
          <div class="lessonMeta">${escapeHtml(extra)} ${escapeHtml(bestLine)}</div>
        </button>
      `;
    }).join("");

    const totalsBestPct = save.totals.bestAnswered ? Math.round((save.totals.bestCorrect/save.totals.bestAnswered)*100) : 0;

    el("card").innerHTML = `
      <h2>Home</h2>
      <p class="kicker">
        Scegli una lezione. Il progresso si salva automaticamente sul dispositivo.
      </p>

      <div class="theoryBox">
        <div class="mono" style="white-space:normal;">
          <strong>Totale migliore:</strong> ${save.totals.bestCorrect}/${save.totals.bestAnswered} (${totalsBestPct}%)
          <br>
          <strong>Lezioni completate:</strong> ${save.perLesson.filter(x=>x.completed).length}/${lessons.length}
        </div>
      </div>

      <div class="rowBtns">
        <button class="navBtn primary" onclick="continueLast()">Continua ‚ñ∂Ô∏è</button>
        <button class="navBtn" onclick="goFinal()">Riepilogo üßæ</button>
      </div>

      <div class="rowBtns">
        <button class="navBtn" onclick="setAllToNotCompleted()">Segna tutte ‚Äúda fare‚Äù</button>
        <button class="navBtn danger" onclick="confirmReset()">Reset progresso</button>
      </div>

      <div class="list">${items}</div>

      <div class="small">
        Tip: se una lezione √® sotto 80%, rifai ‚ÄúRifai sbagliate‚Äù finch√© arrivi almeno a 4/5.
      </div>
    `;

    el("note").textContent = "Tocca una lezione per iniziare. 'Continua' riprende dall‚Äôultimo punto salvato.";
    updateLastPosition();
  }

  function confirmReset(){
    const ok = confirm("Vuoi davvero azzerare tutto il progresso su questo dispositivo?");
    if(!ok) return;
    resetProgress();
    // reload into runtime
    save = loadSave();
    state.mode = "home";
    state.lessonIndex = 0;
    state.questionIndex = 0;
    state.retryWrong = false;
    state.wrongQueue = [];
    state.currentQuizIndices = [];
    resetRunStats();
    render();
  }

  function setAllToNotCompleted(){
    save.perLesson = save.perLesson.map(s => ({...s, completed:false}));
    saveNow();
    renderHome();
  }

  function continueLast(){
    // If lastPosition points to a mode that requires context, go there; else home
    const lp = save.lastPosition || { mode:"home", lessonIndex:0, questionIndex:0, retryWrong:false, wrongQueue:[] };
    state.mode = lp.mode || "home";
    state.lessonIndex = clampInt(lp.lessonIndex, 0, lessons.length-1, 0);
    state.questionIndex = clampInt(lp.questionIndex, 0, 4, 0);
    state.retryWrong = !!lp.retryWrong;
    state.wrongQueue = Array.isArray(lp.wrongQueue) ? lp.wrongQueue.slice() : [];
    resetRunStats();
    // If the last mode was quiz but wrongQueue is empty while retryWrong true, fix it:
    if(state.mode === "quiz" && state.retryWrong && state.wrongQueue.length === 0){
      state.retryWrong = false;
    }
    render();
  }

  function startLesson(i){
    state.lessonIndex = i;
    state.mode = "theory";
    state.retryWrong = false;
    state.wrongQueue = [];
    resetRunStats();
    render();
  }

  function goFinal(){
    state.mode = "final";
    setNav(false);
    renderFinal();
  }

  // ==========================================================
  // THEORY / QUIZ / END
  // ==========================================================
  function resetRunStats(){
    state.answered = false;
    state.runCorrect = 0;
    state.runAnswered = 0;
    state.wrongThisRun = [];
    state.currentQuizIndices = [];
  }

  function renderTheory(){
    setNav(true);
    const L = lessons[state.lessonIndex];
    el("card").innerHTML = `
      <h2>${escapeHtml(L.title)}</h2>
      <p class="kicker">${escapeHtml(L.kicker)}</p>
      <div class="theoryBox">
        <pre class="mono">${escapeHtml(L.theory)}</pre>
      </div>

      <div class="scoreBox">
        <div class="scoreItem">Lezione: <span>${state.lessonIndex+1}</span>/<span>${lessons.length}</span></div>
        <div class="scoreItem">Record lezione: <span>${save.perLesson[state.lessonIndex].bestCorrect}</span>/<span>${save.perLesson[state.lessonIndex].bestAnswered}</span></div>
      </div>

      <div class="small">Leggi 20‚Äì30 secondi. Poi premi ‚ÄúInizia quiz‚Äù.</div>
    `;

    el("backBtn").disabled = false;
    el("backBtn").textContent = "üè† Home";
    el("nextBtn").disabled = false;
    el("nextBtn").textContent = "Inizia quiz üéØ";
    el("note").textContent = "Nel quiz: scegli una risposta ‚Üí feedback immediato + spiegazione.";
    updateLastPosition();
  }

  function buildQuizIndices(){
    if(state.retryWrong){
      // queue may contain duplicates; normalize & keep in order
      const uniq = [];
      for(const idx of state.wrongQueue){
        const n = clampInt(idx, 0, 4, null);
        if(n === null) continue;
        if(!uniq.includes(n)) uniq.push(n);
      }
      state.currentQuizIndices = uniq;
    } else {
      state.currentQuizIndices = [0,1,2,3,4];
    }
  }

  function renderQuiz(){
    setNav(true);
    const L = lessons[state.lessonIndex];
    buildQuizIndices();

    // if retryWrong and nothing to retry, go to lesson_end
    if(state.retryWrong && state.currentQuizIndices.length === 0){
      state.mode = "lesson_end";
      renderLessonEnd();
      return;
    }

    // map questionIndex to real index
    const qPos = clampInt(state.questionIndex, 0, state.currentQuizIndices.length-1, 0);
    state.questionIndex = qPos;
    const realIdx = state.currentQuizIndices[qPos];
    const Q = L.quiz[realIdx];

    state.answered = false;

    const totalQs = state.currentQuizIndices.length;
    const label = state.retryWrong ? `Rifai sbagliate: ${qPos+1}/${totalQs}` : `Domanda ${qPos+1}/5`;

    el("card").innerHTML = `
      <h2>${escapeHtml(L.title)}</h2>
      <p class="kicker">${label} ‚Äî scegli una risposta.</p>

      <div class="theoryBox" style="margin-bottom:12px;">
        <div class="mono" style="white-space:normal;">
          <strong>Mini-promemoria:</strong> ${escapeHtml(L.kicker)}
        </div>
      </div>

      <p class="q">${escapeHtml(Q.q)}</p>
      <div id="opts"></div>
      <div id="fb" class="hidden"></div>

      <div class="scoreBox">
        <div class="scoreItem">Run: <span>${state.runCorrect}</span>/<span>${state.runAnswered}</span></div>
        <div class="scoreItem">Record lezione: <span>${save.perLesson[state.lessonIndex].bestCorrect}</span>/<span>${save.perLesson[state.lessonIndex].bestAnswered}</span></div>
      </div>
    `;

    const optsWrap = document.getElementById("opts");
    Q.opts.forEach((t, i) => {
      const b = document.createElement("button");
      b.className = "opt";
      b.textContent = t;
      b.addEventListener("click", () => answer(i, realIdx));
      optsWrap.appendChild(b);
    });

    el("backBtn").disabled = true;
    el("nextBtn").disabled = true; // sblocca dopo risposta
    el("nextBtn").textContent = (qPos === totalQs - 1) ? "Fine ‚û°Ô∏è" : "Prossima ‚û°Ô∏è";
    el("note").textContent = "Devi rispondere per sbloccare ‚ÄúProssima‚Äù.";
    updateLastPosition();
  }

  function answer(choiceIndex, realIdx){
    if(state.answered) return;
    state.answered = true;

    const L = lessons[state.lessonIndex];
    const Q = L.quiz[realIdx];
    const opts = Array.from(document.querySelectorAll(".opt"));
    opts.forEach(btn => btn.disabled = true);

    const correct = (choiceIndex === Q.c);

    // mark correct + wrong
    opts.forEach((btn, idx) => {
      if(idx === Q.c) btn.classList.add("correct");
      if(idx === choiceIndex && !correct) btn.classList.add("wrong");
    });

    // run stats
    state.runAnswered += 1;
    if(correct) state.runCorrect += 1;
    else {
      // track wrong of the ORIGINAL 5-question lesson indices (0..4)
      if(!state.wrongThisRun.includes(realIdx)) state.wrongThisRun.push(realIdx);
    }

    // feedback always
    const fb = document.getElementById("fb");
    fb.className = "feedback " + (correct ? "ok" : "bad");
    fb.innerHTML = `
      <strong>${correct ? "‚úÖ GIUSTO" : "‚ùå SBAGLIATO"}</strong><br>
      <strong>Spiegazione:</strong> ${escapeHtml(Q.ex)}
    `;
    fb.classList.remove("hidden");

    el("nextBtn").disabled = false;
  }

  function finalizeLessonRun(){
    const li = state.lessonIndex;
    const s = save.perLesson[li];

    // Save last run
    s.lastCorrect = state.runCorrect;
    s.lastAnswered = state.runAnswered;
    // Save wrong from last run (store 0..4 indices)
    s.wrongLast = state.wrongThisRun.slice().sort((a,b)=>a-b);

    // Update best for lesson ONLY if it was a full 5-question run (not retryWrong)
    if(!state.retryWrong && state.runAnswered === 5){
      if(state.runCorrect > s.bestCorrect){
        s.bestCorrect = state.runCorrect;
        s.bestAnswered = 5;
      }
      // Mark completed if score >= 4/5 (you can change threshold)
      if(state.runCorrect >= 4) s.completed = true;
    }

    // Update totals best across all lessons: compute from lesson bests
    // totals.bestCorrect = sum of bestCorrect; bestAnswered = lessons*5
    save.totals.bestAnswered = lessons.length * 5;
    save.totals.bestCorrect = save.perLesson.reduce((acc, x) => acc + (Number(x.bestCorrect)||0), 0);

    saveNow();
  }

  function renderLessonEnd(){
    setNav(true);
    finalizeLessonRun();

    const L = lessons[state.lessonIndex];
    const s = save.perLesson[state.lessonIndex];
    const lastPct = s.lastAnswered ? Math.round((s.lastCorrect/s.lastAnswered)*100) : 0;
    const bestPct = s.bestAnswered ? Math.round((s.bestCorrect/s.bestAnswered)*100) : 0;

    const wrongCount = (s.wrongLast || []).length;

    let badge = "Da rinforzare üí™";
    if(lastPct >= 90) badge = "Ottimo üî•";
    else if(lastPct >= 70) badge = "Buono ‚úÖ";

    const wrongLine = wrongCount > 0
      ? `Hai sbagliato ${wrongCount} domanda/e.`
      : `Nessun errore: perfetto!`;

    const retryBtn = wrongCount > 0
      ? `<button class="navBtn primary" onclick="retryWrong()">Rifai sbagliate üîÅ</button>`
      : `<button class="navBtn primary" onclick="nextLessonOrFinal()">${state.lessonIndex === lessons.length-1 ? "Vai al finale üèÅ" : "Prossima lezione ‚û°Ô∏è"}</button>`;

    const otherBtn = wrongCount > 0
      ? `<button class="navBtn" onclick="nextLessonOrFinal()">${state.lessonIndex === lessons.length-1 ? "Salta e vai al finale üèÅ" : "Prossima lezione ‚û°Ô∏è"}</button>`
      : `<button class="navBtn" onclick="goHome()">Torna alla Home üè†</button>`;

    el("card").innerHTML = `
      <h2>Fine lezione</h2>
      <p class="kicker">${escapeHtml(L.title)} ‚Äî ${badge}</p>

      <div class="theoryBox">
        <div class="mono" style="white-space:normal;">
          <strong>Ultimo punteggio:</strong> ${s.lastCorrect}/${s.lastAnswered} (${lastPct}%)
          <br>
          <strong>Record lezione:</strong> ${s.bestCorrect}/${s.bestAnswered} (${bestPct}%)
          <br>
          <strong>Stato:</strong> ${s.completed ? "‚úÖ Completata" : "üïí Da fare"}
          <br>
          <strong>Errori:</strong> ${wrongLine}
        </div>
      </div>

      <div class="rowBtns">
        ${retryBtn}
        ${otherBtn}
      </div>

      <div class="rowBtns">
        <button class="navBtn" onclick="restartLesson()">Rifai tutta la lezione ‚Ü©Ô∏è</button>
        <button class="navBtn" onclick="goHome()">Home üè†</button>
      </div>

      <div class="small">
        Consiglio pratico: se hai fatto 3/5 o meno, rifai ‚ÄúRifai sbagliate‚Äù e poi ‚ÄúRifai tutta la lezione‚Äù.
      </div>
    `;

    el("backBtn").disabled = true;
    el("nextBtn").disabled = true;
    el("note").textContent = "Qui scegli cosa fare: rifare sbagliate, passare oltre o tornare alla Home.";
    updateLastPosition();
  }

  function retryWrong(){
    const li = state.lessonIndex;
    const wrong = (save.perLesson[li].wrongLast || []).slice();
    state.retryWrong = true;
    state.wrongQueue = wrong;
    state.mode = "quiz";
    state.questionIndex = 0;
    resetRunStats();
    render();
  }

  function restartLesson(){
    state.retryWrong = false;
    state.wrongQueue = [];
    state.mode = "theory";
    state.questionIndex = 0;
    resetRunStats();
    render();
  }

  function nextLessonOrFinal(){
    if(state.lessonIndex < lessons.length - 1){
      state.lessonIndex += 1;
      state.retryWrong = false;
      state.wrongQueue = [];
      state.mode = "theory";
      state.questionIndex = 0;
      resetRunStats();
      render();
    } else {
      state.mode = "final";
      renderFinal();
    }
  }

  function goHome(){
    state.mode = "home";
    state.retryWrong = false;
    state.wrongQueue = [];
    resetRunStats();
    render();
  }

  // ==========================================================
  // FINALE (riepilogo semplice)
  // ==========================================================
  function renderFinal(){
    setNav(false);

    const bestTotalPct = save.totals.bestAnswered ? Math.round((save.totals.bestCorrect/save.totals.bestAnswered)*100) : 0;
    const completed = save.perLesson.filter(x => x.completed).length;

    const breakdown = lessons.map((L, i) => {
      const s = save.perLesson[i];
      const bestPct = s.bestAnswered ? Math.round((s.bestCorrect/s.bestAnswered)*100) : 0;
      const lastPct = s.lastAnswered ? Math.round((s.lastCorrect/s.lastAnswered)*100) : 0;
      const tag = s.completed ? "‚úÖ" : "üïí";
      const wrongCount = (s.wrongLast || []).length;
      const hint = (!s.completed && wrongCount > 0) ? ` ‚Äî Rifai sbagliate (${wrongCount})` : "";
      return `
        <button class="lessonBtn" onclick="startLesson(${i})">
          <div class="lessonTop">
            <div class="lessonName">${tag} ${escapeHtml(L.title)}</div>
            <div class="tag">Best ${bestPct}%</div>
          </div>
          <div class="lessonMeta">Ultima: ${s.lastAnswered ? `${s.lastCorrect}/${s.lastAnswered} (${lastPct}%)` : "‚Äî"}${escapeHtml(hint)}</div>
        </button>
      `;
    }).join("");

    el("card").innerHTML = `
      <h2>Riepilogo</h2>
      <p class="kicker">Qui vedi cosa ripassare. Tocca una lezione per rientrare.</p>

      <div class="theoryBox">
        <div class="mono" style="white-space:normal;">
          <strong>Totale migliore:</strong> ${save.totals.bestCorrect}/${save.totals.bestAnswered} (${bestTotalPct}%)
          <br>
          <strong>Lezioni completate:</strong> ${completed}/${lessons.length}
        </div>
      </div>

      <div class="rowBtns">
        <button class="navBtn primary" onclick="goHome()">Home üè†</button>
        <button class="navBtn danger" onclick="confirmReset()">Reset progresso</button>
      </div>

      <div class="list">${breakdown}</div>
    `;

    el("note").textContent = "Suggerimento: entra nelle lezioni non completate e usa ‚ÄúRifai sbagliate‚Äù.";
    updateLastPosition();
  }

  // ==========================================================
  // ROUTER / NAV BUTTONS
  // ==========================================================
  function render(){
    setTopUI();
    if(state.mode === "home") renderHome();
    else if(state.mode === "theory") renderTheory();
    else if(state.mode === "quiz") renderQuiz();
    else if(state.mode === "lesson_end") renderLessonEnd();
    else renderFinal();
  }

  function goBack(){
    // Back is kept super-simple for mobile:
    // - from theory: go home
    // - from quiz: disabled (avoid confusion)
    // - from lesson_end: home
    // - from final: home
    if(state.mode === "theory") goHome();
    else if(state.mode === "lesson_end") goHome();
    else if(state.mode === "final") goHome();
  }

  function goNext(){
    if(state.mode === "theory"){
      state.mode = "quiz";
      state.questionIndex = 0;
      state.retryWrong = false;
      state.wrongQueue = [];
      resetRunStats();
      render();
      return;
    }

    if(state.mode === "quiz"){
      // locked until answered
      if(!state.answered) return;

      // advance within current quiz set
      const totalQs = state.retryWrong ? state.currentQuizIndices.length : 5;
      if(state.questionIndex < totalQs - 1){
        state.questionIndex += 1;
        render();
      } else {
        state.mode = "lesson_end";
        render();
      }
      return;
    }

    if(state.mode === "home"){
      continueLast();
      return;
    }

    if(state.mode === "lesson_end"){
      nextLessonOrFinal();
      return;
    }
  }

  // Buttons
  el("backBtn").addEventListener("click", goBack);
  el("nextBtn").addEventListener("click", goNext);

  // First render
  render();
</script>
</body>
</html>
